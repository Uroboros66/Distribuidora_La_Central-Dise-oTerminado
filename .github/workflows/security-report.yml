name: 游늵 Reporte Consolidado de Seguridad .NET

on:
  workflow_run:
    workflows: ["An치lisis de C칩digo (.NET SAST)", "An치lisis de Dependencias (.NET)"]
    types:
      - completed

permissions:
  issues: write
  contents: read

jobs:
  generar-reporte:
    name: Generar Dashboard Ejecutivo
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout del repositorio
        uses: actions/checkout@v4

      - name: 游닌 Descargar artefactos previos
        uses: actions/download-artifact@v4
        with:
          path: ./analisis

      - name: 游늵 Generar dashboard HTML consolidado
        run: |
          echo "<html><head><title>Reporte de Seguridad - Distribuidora La Central</title></head><body>" > security-dashboard.html
          echo "<h1>Consolidado de Seguridad</h1>" >> security-dashboard.html
          echo "<p>Generado autom치ticamente por GitHub Actions</p>" >> security-dashboard.html

          echo "<h2>Resultados Semgrep (SAST)</h2>" >> security-dashboard.html
          if [ -f "./analisis/semgrep-results/semgrep-results.json" ]; then
            echo "<pre>" >> security-dashboard.html
            cat ./analisis/semgrep-results/semgrep-results.json >> security-dashboard.html
            echo "</pre>" >> security-dashboard.html
          else
            echo "<p>丘멆잺 No se encontraron resultados de Semgrep.</p>" >> security-dashboard.html
          fi

          echo "<h2>Reporte OWASP Dependency Check</h2>" >> security-dashboard.html
          if [ -f "./analisis/dependency-report/dependency-check-report.html" ]; then
            echo "<iframe src='./analisis/dependency-report/dependency-check-report.html' width='100%' height='800'></iframe>" >> security-dashboard.html
          else
            echo "<p>丘멆잺 No se encontr칩 el reporte de dependencias.</p>" >> security-dashboard.html
          fi

          echo "</body></html>" >> security-dashboard.html

      - name: 游닇 Generar informe ejecutivo
        run: |
          PROJECT_NAME=$(basename "$(git rev-parse --show-toplevel)")
          echo "# 游늵 Informe de Seguridad - $PROJECT_NAME" > EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "## Resumen Ejecutivo" >> EXECUTIVE_SUMMARY.md
          echo "- Calificaci칩n de seguridad general: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Vulnerabilidades cr칤ticas: $(grep -o '"severity": *"CRITICAL"' ./analisis/semgrep-results/semgrep-results.json 2>/dev/null | wc -l)" >> EXECUTIVE_SUMMARY.md
          echo "- Vulnerabilidades de alta severidad: $(grep -o '"severity": *"HIGH"' ./analisis/semgrep-results/semgrep-results.json 2>/dev/null | wc -l)" >> EXECUTIVE_SUMMARY.md
          echo "- Puntos fuertes identificados: TBD" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "## Hallazgos Cr칤ticos" >> EXECUTIVE_SUMMARY.md
          echo "| ID | Severidad | Tipo | Ubicaci칩n | Recomendaci칩n |" >> EXECUTIVE_SUMMARY.md
          echo "|----|-----------|------|-----------|---------------|" >> EXECUTIVE_SUMMARY.md
          if [ -f "./analisis/semgrep-results/semgrep-results.json" ]; then
            jq -r '.results[] | select(.extra.severity=="CRITICAL") | "| \(.check_id // "N/A") | \(.extra.severity) | \(.extra.metadata.category // "N/A") | \(.path // "N/A"):\(.start.line // "N/A") | Revisar c칩digo y aplicar buenas pr치cticas |"' ./analisis/semgrep-results/semgrep-results.json >> EXECUTIVE_SUMMARY.md || true
          else
            echo "| N/A | N/A | N/A | N/A | N/A |" >> EXECUTIVE_SUMMARY.md
          fi
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "## An치lisis por Categor칤a" >> EXECUTIVE_SUMMARY.md
          echo "### 游댌 C칩digo" >> EXECUTIVE_SUMMARY.md
          echo "- Problemas de inyecci칩n: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Gesti칩n de sesiones: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Validaci칩n de entrada: TBD" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "### 游닍 Dependencias" >> EXECUTIVE_SUMMARY.md
          echo "- Dependencias con vulnerabilidades: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Librer칤as desactualizadas: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Licencias problem치ticas: TBD" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "## Recomendaciones Prioritarias" >> EXECUTIVE_SUMMARY.md
          echo "1. [ ] Remediar vulnerabilidades cr칤ticas inmediatamente" >> EXECUTIVE_SUMMARY.md
          echo "2. [ ] Actualizar dependencias afectadas" >> EXECUTIVE_SUMMARY.md
          echo "3. [ ] Implementar medidas adicionales de seguridad (validaciones, controles de acceso, etc.)" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "## M칠tricas de Mejora" >> EXECUTIVE_SUMMARY.md
          echo "- Cobertura de an치lisis: TBD%" >> EXECUTIVE_SUMMARY.md
          echo "- Tiempo de remediaci칩n estimado: TBD d칤as" >> EXECUTIVE_SUMMARY.md
          echo "- Impacto en seguridad: Alto/Medio/Bajo" >> EXECUTIVE_SUMMARY.md

      - name: 游닋 Subir dashboard consolidado
        uses: actions/upload-artifact@v4
        with:
          name: security-dashboard
          path: security-dashboard.html

      - name: 游닋 Subir informe ejecutivo
        uses: actions/upload-artifact@v4
        with:
          name: executive-summary
          path: EXECUTIVE_SUMMARY.md

      - name: 游 Crear issue autom치tico con hallazgos
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "游 Reporte Consolidado de Seguridad"
          content-filepath: EXECUTIVE_SUMMARY.md
          labels: seguridad, reporte
