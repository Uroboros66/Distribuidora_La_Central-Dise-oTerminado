name: 📊 Reporte Consolidado de Seguridad .NET

on:
  workflow_run:
    workflows: ["Análisis de Código (.NET SAST)", "Análisis de Dependencias (.NET)"]
    types:
      - completed

permissions:
  issues: write
  contents: read

jobs:
  generar-reporte:
    name: Generar Dashboard Ejecutivo
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout del repositorio
        uses: actions/checkout@v4

      - name: 📥 Descargar artefactos previos
        uses: actions/download-artifact@v4
        with:
          path: ./analisis

      - name: 📊 Generar dashboard HTML consolidado
        run: |
          echo "<html><head><title>Reporte de Seguridad - Distribuidora La Central</title></head><body>" > security-dashboard.html
          echo "<h1>Consolidado de Seguridad</h1>" >> security-dashboard.html
          echo "<p>Generado automáticamente por GitHub Actions</p>" >> security-dashboard.html

          echo "<h2>Resultados Semgrep (SAST)</h2>" >> security-dashboard.html
          if [ -f "./analisis/semgrep-results/semgrep-results.json" ]; then
            echo "<pre>" >> security-dashboard.html
            cat ./analisis/semgrep-results/semgrep-results.json >> security-dashboard.html
            echo "</pre>" >> security-dashboard.html
          else
            echo "<p>⚠️ No se encontraron resultados de Semgrep.</p>" >> security-dashboard.html
          fi

          echo "<h2>Reporte OWASP Dependency Check</h2>" >> security-dashboard.html
          if [ -f "./analisis/dependency-report/dependency-check-report.html" ]; then
            echo "<iframe src='./analisis/dependency-report/dependency-check-report.html' width='100%' height='800'></iframe>" >> security-dashboard.html
          else
            echo "<p>⚠️ No se encontró el reporte de dependencias.</p>" >> security-dashboard.html
          fi

          echo "</body></html>" >> security-dashboard.html

      - name: 📝 Generar informe ejecutivo
        run: |
          PROJECT_NAME=$(basename "$(git rev-parse --show-toplevel)")
          echo "# 📊 Informe de Seguridad - $PROJECT_NAME" > EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "## Resumen Ejecutivo" >> EXECUTIVE_SUMMARY.md
          echo "- Calificación de seguridad general: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Vulnerabilidades críticas: $(grep -o '"severity": *"CRITICAL"' ./analisis/semgrep-results/semgrep-results.json 2>/dev/null | wc -l)" >> EXECUTIVE_SUMMARY.md
          echo "- Vulnerabilidades de alta severidad: $(grep -o '"severity": *"HIGH"' ./analisis/semgrep-results/semgrep-results.json 2>/dev/null | wc -l)" >> EXECUTIVE_SUMMARY.md
          echo "- Puntos fuertes identificados: TBD" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "## Hallazgos Críticos" >> EXECUTIVE_SUMMARY.md
          echo "| ID | Severidad | Tipo | Ubicación | Recomendación |" >> EXECUTIVE_SUMMARY.md
          echo "|----|-----------|------|-----------|---------------|" >> EXECUTIVE_SUMMARY.md
          if [ -f "./analisis/semgrep-results/semgrep-results.json" ]; then
            jq -r '.results[] | select(.extra.severity=="CRITICAL") | "| \(.check_id // "N/A") | \(.extra.severity) | \(.extra.metadata.category // "N/A") | \(.path // "N/A"):\(.start.line // "N/A") | Revisar código y aplicar buenas prácticas |"' ./analisis/semgrep-results/semgrep-results.json >> EXECUTIVE_SUMMARY.md || true
          else
            echo "| N/A | N/A | N/A | N/A | N/A |" >> EXECUTIVE_SUMMARY.md
          fi
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "## Análisis por Categoría" >> EXECUTIVE_SUMMARY.md
          echo "### 🔍 Código" >> EXECUTIVE_SUMMARY.md
          echo "- Problemas de inyección: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Gestión de sesiones: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Validación de entrada: TBD" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "### 📦 Dependencias" >> EXECUTIVE_SUMMARY.md
          echo "- Dependencias con vulnerabilidades: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Librerías desactualizadas: TBD" >> EXECUTIVE_SUMMARY.md
          echo "- Licencias problemáticas: TBD" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "## Recomendaciones Prioritarias" >> EXECUTIVE_SUMMARY.md
          echo "1. [ ] Remediar vulnerabilidades críticas inmediatamente" >> EXECUTIVE_SUMMARY.md
          echo "2. [ ] Actualizar dependencias afectadas" >> EXECUTIVE_SUMMARY.md
          echo "3. [ ] Implementar medidas adicionales de seguridad (validaciones, controles de acceso, etc.)" >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md

          echo "## Métricas de Mejora" >> EXECUTIVE_SUMMARY.md
          echo "- Cobertura de análisis: TBD%" >> EXECUTIVE_SUMMARY.md
          echo "- Tiempo de remediación estimado: TBD días" >> EXECUTIVE_SUMMARY.md
          echo "- Impacto en seguridad: Alto/Medio/Bajo" >> EXECUTIVE_SUMMARY.md

      - name: 📤 Subir dashboard consolidado
        uses: actions/upload-artifact@v4
        with:
          name: security-dashboard
          path: security-dashboard.html

      - name: 📤 Subir informe ejecutivo
        uses: actions/upload-artifact@v4
        with:
          name: executive-summary
          path: EXECUTIVE_SUMMARY.md

      - name: 🐞 Crear issue automático con hallazgos
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "🔒 Reporte Consolidado de Seguridad"
          content-filepath: EXECUTIVE_SUMMARY.md
          labels: seguridad, reporte
