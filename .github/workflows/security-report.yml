name: ğŸ“Š Reporte Consolidado de Seguridad .NET

on:
  workflow_run:
    workflows: ["AnÃ¡lisis de CÃ³digo (.NET SAST)", "AnÃ¡lisis de Dependencias (.NET)"]
    types:
      - completed
      
permissions:
  issues: write
  contents: read

jobs:
  generar-reporte:
    name: Generar Dashboard Ejecutivo
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout del repositorio
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar artefactos previos
        uses: actions/download-artifact@v4
        with:
          path: ./analisis

      - name: ğŸ“Š Generar dashboard HTML consolidado
        run: |
          echo "<html><head><title>Reporte de Seguridad - Distribuidora La Central</title></head><body>" > security-dashboard.html
          echo "<h1>Consolidado de Seguridad</h1>" >> security-dashboard.html
          echo "<p>Generado automÃ¡ticamente por GitHub Actions</p>" >> security-dashboard.html

          echo "<h2>Resultados Semgrep (SAST)</h2>" >> security-dashboard.html
          if [ -f "./analisis/semgrep-results/semgrep-results.json" ]; then
            echo "<pre>" >> security-dashboard.html
            cat ./analisis/semgrep-results/semgrep-results.json >> security-dashboard.html
            echo "</pre>" >> security-dashboard.html
          else
            echo "<p>âš ï¸ No se encontraron resultados de Semgrep.</p>" >> security-dashboard.html
          fi

          echo "<h2>Reporte OWASP Dependency Check</h2>" >> security-dashboard.html
          if [ -f "./analisis/dependency-report/dependency-check-report.html" ]; then
            echo "<iframe src='./analisis/dependency-report/dependency-check-report.html' width='100%' height='800'></iframe>" >> security-dashboard.html
          else
            echo "<p>âš ï¸ No se encontrÃ³ el reporte de dependencias.</p>" >> security-dashboard.html
          fi

          echo "</body></html>" >> security-dashboard.html

      - name: ğŸ“ Generar resumen ejecutivo
        run: |
          echo "# ğŸ“Š Resumen Ejecutivo de Seguridad" > EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "Este reporte fue generado automÃ¡ticamente." >> EXECUTIVE_SUMMARY.md
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "## Resultados Semgrep" >> EXECUTIVE_SUMMARY.md
          if [ -f "./analisis/semgrep-results/semgrep-results.json" ]; then
            echo "\`\`\`json" >> EXECUTIVE_SUMMARY.md
            cat ./analisis/semgrep-results/semgrep-results.json >> EXECUTIVE_SUMMARY.md
            echo "\`\`\`" >> EXECUTIVE_SUMMARY.md
          else
            echo "- âš ï¸ No se encontraron resultados de Semgrep." >> EXECUTIVE_SUMMARY.md
          fi
          echo "" >> EXECUTIVE_SUMMARY.md
          echo "## Reporte de Dependencias" >> EXECUTIVE_SUMMARY.md
          if [ -f "./analisis/dependency-report/dependency-check-report.html" ]; then
            echo "- âœ… Reporte de dependencias generado correctamente." >> EXECUTIVE_SUMMARY.md
          else
            echo "- âš ï¸ No se encontrÃ³ el reporte de dependencias." >> EXECUTIVE_SUMMARY.md
          fi

      - name: ğŸ“¤ Subir dashboard consolidado
        uses: actions/upload-artifact@v4
        with:
          name: security-dashboard
          path: security-dashboard.html

      - name: ğŸ“¤ Subir resumen ejecutivo
        uses: actions/upload-artifact@v4
        with:
          name: executive-summary
          path: EXECUTIVE_SUMMARY.md

      - name: ğŸ Crear issue automÃ¡tico con hallazgos
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ğŸ”’ Reporte Consolidado de Seguridad"
          content-filepath: EXECUTIVE_SUMMARY.md
          labels: seguridad, reporte
